---
title: "STA 3241 Final Project"
output:
  html_notebook:
    number_sections: no
    toc: true
    toc_depth: 4
    toc_float: true
  html_document:
    toc: true
    toc_depth: '4'
    df_print: paged
    toc_float: true
  pdf_document:
    toc: true
    toc_depth: '4'
---

# ***Library Loading:***
```{r, message=F}
library(tidyverse)
library(dplyr)
library(openxlsx)
library(tidytext)
library(forcats)
library(lubridate)
library(data.table)
library(factoextra)
library(gbm)
library(caret)
library(randomForest)
library(rpart.plot)
library(tree)
library(readr)
```

# ***Data Frame Creation:***
```{r, warning=F}
ufo <- read.xlsx("ufo-complete-geocoded-time-standardized.xlsx")
ufo$Seconds <- as.double(ufo$Seconds)
ufo <- ufo %>% 
  mutate(shape_rev = as.factor(ifelse(ufo$Shape == "Light", "Light", "Shape")))
ufo$State_Province <- as.factor(ufo$State_Province)
ufo$Country <-  as.factor(ufo$Country)
ufo$Latitude <- as.double(ufo$Latitude)
ufo$Longitude <- as.double(ufo$Longitude)
ufo$City <- as.factor(ufo$City)
ufo$Date <- as.IDate(ufo$Date, origin = "1900/1/1")
ufo$Date_Posted <- as.IDate(as.numeric(ufo$Date_Posted), origin = "1900/1/1")
ufo$Time <- as.ITime(24*ufo$Time*3600)
ufo <- ufo %>% 
  select(-Column1, X14)
head(ufo)
```


```{r}
#predict region based off of hemisphere such as northern and southern hemisphere. 

```

# ***Create Separate data frames to hold the count values***

## create separate df with the count of reports by **country**
```{r}
ufo$Country <-  as.character(ufo$Country)

ufo_country_count <- as.data.frame(table(ufo$Country))
colnames(ufo_country_count) <- c('Country','Count')
ufo_country_count <- ufo_country_count %>% 
  arrange(desc(Count))

ufo$Country <-  as.factor(ufo$Country)
```

## create separate df with the count of each **shape** reported
```{r}
ufo$Shape <-  as.character(ufo$Shape)

ufo_shape_count <- as.data.frame(table(ufo$Shape))
colnames(ufo_shape_count) <- c('Shape','Count')
ufo_shape_count <- ufo_shape_count %>% 
  arrange(desc(Count))

ufo$Shape <-  as.factor(ufo$Shape)
```

## create separate df with the count of reports by **U.S. state**
```{r}
ufo$Country <-  as.character(ufo$Country)

# First make a df of reports only in the U.S.
ufo_USA <- ufo %>% 
  filter(Country == "United States")

ufo_USA$State_Province <-  as.character(ufo_USA$State_Province)

ufo_state_count <- as.data.frame(table(ufo_USA$State_Province))
colnames(ufo_state_count) <- c('State_Province','Count')
ufo_state_count <- ufo_state_count %>% 
  arrange(desc(Count))

ufo$Country <-  as.factor(ufo$Country)
ufo$State_Province <- as.factor(ufo$State_Province)
```

## create df for **training set**
```{r}
ufo_to_train <- ufo_USA 

ufo_to_train <- ufo_to_train %>% 
  filter(Shape %in% c("light", "sphere", "circle", "disk", "cigar", "changing", "unknown", "triangle", "other", "oval", "cylinder", "fireball", "rectangle", "formation", "flash", "chevron", "egg", "cone", "diamond", "teardrop", "cross")) %>%
  select(-Summary, -X14, -shape_rev, -Duration, -City) %>% 
  drop_na()

# ufo_to_train$Latitude <-  as.float(ufo_to_train$Latitude)
# ufo_to_train$Longitude <-  as.float(ufo_to_train$Longitude)

ufo_to_train <- ufo_to_train %>%
  filter(Latitude != 0.00000) %>%
  filter(Longitude != 0.00000)
```

```{r}
ufo_to_train$Shape <-  as.character(ufo_to_train$Shape)

ufo_tt_shape_count <- as.data.frame(table(ufo_to_train$Shape))
colnames(ufo_tt_shape_count) <- c('Shape','Count')
ufo_tt_shape_count <- ufo_tt_shape_count %>% 
  arrange(desc(Count))

ufo_to_train$Shape <-  as.factor(ufo_to_train$Shape)
```

# ***Observations by Country:***
```{r}
ufo_country_count %>%
  filter(Count >= 500) %>%
  ggplot(aes(x = reorder(Country, Count),
             y = Count,
             fill = Country)) +
  geom_bar(stat="identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold") +
  coord_flip()+
  labs(title = "Reports by Country",
       x = "Country",
       y = "Number of Specific Reports",
       caption = "*out of 27 total countries, these four are the only ones with >= 500 reports")+
  theme(legend.position ="none") +
  scale_y_continuous(limits = c(0, 85000))
```

As we can see, nearly all of our data is showing reports from within the United States. 
Canada takes second place, followed by Great Britain 
It's noteworthy that Australia, India, and Mexico are displayed on this graph as there are over 600 unique levels. 

```{r, warning=F}
ufo_country_count[1:6, ] %>%
#  filter(Count < 500) %>% 
  ggplot(aes(x = reorder(Country, Count),
             y = Count,
             fill = Country)) +
  coord_flip() +
  geom_bar(stat="identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold") +
  labs(title = "Countries with less than 500 reports",
       x = "# of reports",
       y = "Country"
       ) +
  theme_minimal() +
  theme(legend.position = "none") +
  scale_y_continuous(limits = c(0, 82000))
```

## **Shapes in general:**
```{r}
ufo_shape_count %>%
#  filter(Count >= 1000) %>%
#  filter(ufo_shape_count[1:10, ]) %>% 
  ggplot(aes(x = reorder(Shape, Count),
             y = Count,
             fill = Shape)) +
  coord_flip() +
  geom_bar(stat="identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold") +
  labs(title = "Shape Tendencies", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none") +
  scale_y_continuous(limits = c(0, 18500))
```

## **Top 10 Shapes:**
```{r}
ufo_shape_count[1:10, ] %>%
#  filter(Count >= 1000) %>%
#  filter(ufo_shape_count[1:10, ]) %>% 
  ggplot(aes(x = reorder(Shape, Count),
             y = Count,
             fill = Shape)) +
  coord_flip() +
  geom_bar(stat="identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold") +
  labs(title = "Top 10 Commonly Reported Shapes", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none") +
  scale_y_continuous(limits = c(0, 18500))
```
## **Rest of Shapes:**
```{r}
ufo_shape_count[-9:0, ] %>%
#  filter(Count >= 1000) %>%
#  filter(ufo_shape_count[1:10, ]) %>% 
  ggplot(aes(x = reorder(Shape, Count),
             y = Count,
             fill = Shape)) +
  coord_flip() +
  geom_bar(stat="identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold") +
  labs(title = "Rest of Shape Tendencies",
       x = "Reported Shape",
       y = "Number of Specific Reports")+
    theme(legend.position ="none") +
  scale_y_continuous(limits = c(0, 2700))
```

## **Shape Tendencies > 200:**
```{r}
ufo_shape_count[-21:0, ] %>%
#  filter(Count >= 1000) %>%
#  filter(ufo_shape_count[1:10, ]) %>% 
  ggplot(aes(x = reorder(Shape, Count),
             y = Count,
             fill = Shape)) +
  coord_flip() +
  geom_bar(stat="identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold") +
  labs(title = "Shape Tendencies < 200", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```


## **Which States from the USA?**
```{r}
ufo_state_count %>%
#  filter(Country == "United States")%>%
#  group_by(State_Province)%>%
  filter(Count >= 1000)%>%
  ggplot(aes(x = reorder(State_Province, Count),
             y = Count,
             fill = State_Province))+
  geom_bar(stat = "identity") +
  geom_text(aes(label = Count),
            hjust = -0.1,
            fontface = "bold")+ 
  coord_flip()+
  labs(title = "Reports by State",
       x = "State/Province",
       y = "Number of Specific Reports")+
  theme(legend.position ="none") +
  scale_y_continuous(limits = c(0, 10800))#+
  #facet_wrap(~ State_Province, scales ="free_y")
```

Will work on the visualization, but as we can see, California has some of the highest reports out there. 

## **What Time are these normally viewed at?**
```{r}
ufo %>%
  filter(Country == "United States")%>%
  group_by(State_Province)%>%
  filter(n() >= 1000)%>%
  ggplot()+
  geom_col(aes(x = State_Province, y = Time, fill = State_Province))+ 
  coord_flip()+
  labs(title = "Viewing Time by State", 
       y = "Time")+
    theme(legend.position ="none")
```


# ***Shapes Reported within the U.S.***
```{r}
ufo %>%
  filter(Country == "United States")%>%
  group_by(Shape)%>%
  filter(n() >= 1000)%>%
  ggplot()+
  geom_bar(aes(x = Shape, fill = Shape))+ 
  coord_flip()+
  labs(title = "Shape Tendencies", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```

Light is the most frequent response. 
However, this is followed up by circularity and triangular shapes. 



# ***Oh, Florida:***
```{r}
ufo %>%
  filter(Country == "United States")%>%
  filter(State_Province == "FL")%>%
  group_by(Shape)%>%
  filter(n() >= 100)%>%
  ggplot()+
  geom_bar(aes(x = Shape, fill = Shape))+ 
  coord_flip()+
  labs(title = "Shape Tendencies for Florida", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```

```{r}
ufo %>%
  filter(Country == "United States")%>%
  filter(State_Province == "FL")%>%
  group_by(City)%>%
  filter(n() >= 60)%>%
  ggplot()+
  geom_bar(aes(x = City, fill = City))+ 
  coord_flip()+
  labs(title = "'The Hottest' Cities in Florida for UFO Reports", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```


```{r}
ufo %>%
  filter(Country == "United States")%>%
  filter(State_Province == "CA")%>%
  group_by(City)%>%
  filter(n() >= 100)%>%
  ggplot()+
  geom_bar(aes(x = City, fill = City))+ 
  coord_flip()+
  labs(title = "'The Hottest' Cities in California for UFO Reports", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```




## Locations of Reports in FL
```{r}
ufo %>%
  filter(Country == "United States")%>%
  filter(State_Province == "FL")%>%
  filter(Latitude <= 140)%>%
  filter(Longitude >= -100)%>%
  ggplot()+
  geom_point(aes(x = Latitude, y = Longitude, color = Shape))+ 
  labs(title = "Shape Tendencies for Florida")+
    theme(legend.position ="none")
```


# Decision Tree Stuff for Analysis

prep the data

```{r}
set.seed(1234)

intrain <- createDataPartition(y = ufo_to_train$Shape, p=0.8, list = FALSE)
train_data <- ufo_to_train[intrain, ]
test_data <- ufo_to_train[-intrain, ]
```

Set up Crossvalidation

```{r}
reg_control <-trainControl(method="cv", number = 10)
```

Bagging

```{r}
bag_ufo <- randomForest(Shape ~ .,
                        data = train_data,
                        mtry = 10,
                        importance = T)
bag_ufo
```

# Randomm Forest UFO
```{r}
rf_ufo <- randomForest(Shape ~ .,
                       data = train_data,
                       mtry = 6,
                       importance = T,
                       ntree = 25)
rf_ufo
```

```{r}
yhat_rf_ufo <- predict(rf_ufo,
                       test_data)
plot(yhat_rf_ufo,
     test_data[,9])
abline(0,1)
```

```{r}
importance(rf_ufo)
```

```{r}
varImpPlot(rf_ufo)
```






```{r}
ufo %>%
  filter(Country == "Great Britain")%>%
  filter(City != "Uk/England")%>%
  group_by(City)%>%
  filter(n() >= 35)%>%
  ggplot()+
  geom_bar(aes(x = City, fill = City))+ 
  coord_flip()+
  labs(title = "'The Hottest' Cities in Great Britain for UFO Reports", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```


```{r}
ufo %>%
  filter(Country == "Canada")%>%
  #filter(City != "Uk/England")%>%
  group_by(City)%>%
  filter(n() >= 80)%>%
  ggplot()+
  geom_bar(aes(x = City, fill = City))+ 
  coord_flip()+
  labs(title = "'The Hottest' Cities in Canada for UFO Reports", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```

```{r}
ufo %>%
  filter(Country == "United States")%>%
  #filter(City != "Uk/England")%>%
  group_by(City)%>%
  filter(n() >= 350)%>%
  ggplot()+
  geom_bar(aes(x = City, fill = City))+ 
  coord_flip()+
  labs(title = "'The Hottest' Cities in United States for UFO Reports", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```

```{r}
ufo %>%
  filter(City == "Seattle" | City =="London" | City == "Toronto")%>%
  #filter(City != "Uk/England")%>%
  group_by(Shape)%>%
  filter(n() >= 45)%>%
  ggplot()+
  geom_bar(aes(x = Shape, fill = Shape))+ 
  coord_flip()+
  labs(title = "Most Popular Cities and its Shapes for UFO Reports", 
       y = "Number of Specific Reports")+
    theme(legend.position ="none")
```

